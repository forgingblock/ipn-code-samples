# Handling ForgingBlock IPN Messages With NodeJS

If you have an app that need to accept payments in cryptocurrencies, you will need IPN to communicate with the ForgingBlock servers.

Using ForgingBlock as a platform to accept cryptocurrency payments is a great solution that is as easy as opening ForgingBlock account, creating payment buttons, and adding a few lines of code to your web app.

### What’s an IPN Message?
As a developer, I want to get notify on events when a payment is completed or rejected, in order to change my users’ plan, status, account balance, and even create invoices. That's where IPN (Instant Payment Notification) come in handy.
IPN helps in receiving the success/error messages from ForgingBlock server to your server.

Assuming your server is based on ExpressJS,

In your main app file, make sure you’re using the body-parser middleware so you’ll end up with an index.js file that looks like that:

```js
// index.js
const express = require('express');
const app = express();
const PORT = process.env.PORT || 5000;
var cors = require('cors');

app.use(cors());
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

const routes = require('./routes');

app.use('/', routes);

app.listen(PORT, () => console.log(`App is running on port ${PORT}`));
```

ForgingBlock IPN messages are being sent in POST method, we should add a POST route to our app that will handle these requests:

```js
// routes.js
const router = require('express').Router();
const IPNController = require('./controllers/ipn.ctrl');

router.get('/', (req, res) => { res.status(200).json('Hello World!') })
router.post('/ipn', IPNController.index);

module.exports = router;
```

As you see, we need a controller that should handle the incoming data from ForgingBlock, we'll create it like this:

```js
class IPNController {

    static index(req, res) {
    	console.log(JSON.stringify(req.body));
      // Here is the part that will give you the IPN data
      res.status(200).send('OK');
    }
  }
  
  module.exports = IPNController;
```

That's all what you need for IPN. Now you can use ngrok, heroku, or any other service that will create a public address for the local testing server.

## Building it all out
This section assumes that:
1. You have a website or system where a user can select a product and purchase it with ForgingBlock Payment Gateway API
2. You have an API running that can persist to your database

For example your tech stack is:
1. Front end website is built with ReactJS
2. Backend server is with Express & MongoDB database


React(or any frontend) will directly talk to the ForgingBlock API. The only thing required is the Trade & Token. Trade and Token can be found in the ForgingBlock dashboard.


Once you have the trade and token, you can use the following API to generate a new payment link on which the user will be able to pay in crypto.

`curl 'https://api.forgingblock.io/create-invoice' -H 'Content-Type: application/x-www-form-urlencoded' --data 'trade=yourtrade&token=yourtoken&amount=0.1&currency=usd&order=234&notification=https://yourawesome.site/ipn&link=https://yourawesome.site/payment-success'`

Where 

`order` parameter is the order ID that is generated by your server for your internal uses.
The `url` parameter’s value is an URL where you would receive JSON data after the payment had been made or invoice had expired. Here you will have to use the IPN link that we just created above.

`link` url to follow after the payment

Example of the data you would receive on the url “https://your-api-link.com/ipn” (url param value):

`{"id":"QqZDsqZZNAKqNau23yX9n1","url":"https://api.forgingblock.io/i/QqZDsqZZNAKqNau23yX9n1/BTC","posData":null,"status":"paid","btcPrice":"0.00000213","btcPaid":"0.00000213","btcDue":"0"}`

const { id, btcPrice, btcPaid, btcDue, status, url } = response

Now you have all the data related to the invoice that you generated. You can save it in your DB according to your DB structure.

Cheers!


License
----

MIT
